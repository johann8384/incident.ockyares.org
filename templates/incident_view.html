<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Incident Management - View Incident</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #1976d2; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .content { padding: 20px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-card { background: #f5f5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #1976d2; }
        .info-card h3 { margin: 0 0 10px 0; color: #1976d2; }
        .info-card p { margin: 5px 0; }
        .map-container { margin-bottom: 20px; }
        #map { height: 600px; width: 100%; border: 1px solid #ddd; border-radius: 4px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-secondary { background: #757575; color: white; }
        .btn-success { background: #388e3c; color: white; }
        .btn:hover { opacity: 0.9; }
        .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .status.success { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .status.error { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .divisions-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .division-card { background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 15px; }
        .division-card h4 { margin: 0 0 10px 0; color: #1976d2; }
        .division-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-assigned { background: #4caf50; color: white; }
        .status-unassigned { background: #ff9800; color: white; }
        .status-completed { background: #9c27b0; color: white; }
        .legend { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .legend h4 { margin: 0 0 10px 0; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 3px; margin-right: 10px; }
        .loading { text-align: center; padding: 40px; }
        .back-link { color: #1976d2; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üö® Incident Management Dashboard</h1>
                    <p id="incidentTitle">Loading incident details...</p>
                </div>
                <a href="/" class="back-link" style="color: white; font-size: 16px;">‚Üê Create New Incident</a>
            </div>
        </div>
        
        <div class="content">
            <div id="status" class="status"></div>
            
            <div id="loadingDiv" class="loading">
                <p>Loading incident data...</p>
            </div>
            
            <div id="incidentContent" style="display: none;">
                <div class="info-grid">
                    <div class="info-card">
                        <h3>üìã Incident Information</h3>
                        <div id="incidentInfo">
                            <!-- Incident details will be populated here -->
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3>üìç Location Information</h3>
                        <div id="locationInfo">
                            <!-- Location details will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="map-container">
                    <h3>üó∫Ô∏è Incident Map</h3>
                    <div class="controls">
                        <button class="btn btn-primary" id="centerMapBtn">üéØ Center on Incident</button>
                        <button class="btn btn-secondary" id="toggleDivisionsBtn">üëÅÔ∏è Toggle Divisions</button>
                        <button class="btn btn-success" id="refreshBtn">üîÑ Refresh Data</button>
                    </div>
                    <div id="map"></div>
                </div>
                
                <div class="legend">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #d32f2f;"></div>
                        <span>Incident Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 0, 0, 0.3); border: 2px solid #ff0000;"></div>
                        <span>Search Area</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(76, 175, 80, 0.3); border: 2px solid #4caf50;"></div>
                        <span>Assigned Division</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: rgba(255, 152, 0, 0.3); border: 2px solid #ff9800;"></div>
                        <span>Unassigned Division</span>
                    </div>
                </div>
                
                <div id="divisionsContainer">
                    <h3>üìä Search Divisions</h3>
                    <div id="divisionsSummary">
                        <!-- Summary will be populated here -->
                    </div>
                    <div class="divisions-list" id="divisionsList">
                        <!-- Division cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, incidentMarker, searchAreaLayer, divisionsGroup;
        let incidentData = null;
        let divisionsVisible = true;
        
        // Get incident ID from URL path
        const incidentId = window.location.pathname.split('/').pop();
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 13); // Default to San Francisco
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Initialize feature groups
            searchAreaLayer = new L.FeatureGroup();
            divisionsGroup = new L.FeatureGroup();
            map.addLayer(searchAreaLayer);
            map.addLayer(divisionsGroup);
        }
        
        // Show status message
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        // Load incident data (mock data since API endpoints for viewing aren't implemented yet)
        async function loadIncidentData() {
            try {
                // For now, create mock data since the view API isn't implemented
                // In production, this would be: const response = await fetch(`/api/incident/${incidentId}`);
                
                const mockData = {
                    incident_id: incidentId,
                    name: "Mock Building Collapse Incident",
                    incident_type: "Building Collapse",
                    description: "This is a demonstration incident showing the incident management interface. Real data would be loaded from the API.",
                    status: "active",
                    created_at: new Date().toISOString(),
                    location: {
                        latitude: 37.7749,
                        longitude: -122.4194,
                        address: "San Francisco, CA, USA"
                    },
                    search_area: {
                        coordinates: [
                            [-122.425, 37.770],
                            [-122.415, 37.770],
                            [-122.415, 37.780],
                            [-122.425, 37.780],
                            [-122.425, 37.770]
                        ]
                    },
                    divisions: [
                        {
                            id: 1,
                            division_id: "DIV-A",
                            name: "Division Alpha",
                            status: "assigned",
                            team: "Team 1",
                            area_size: "40,000 m¬≤",
                            priority: "High"
                        },
                        {
                            id: 2,
                            division_id: "DIV-B", 
                            name: "Division Bravo",
                            status: "assigned",
                            team: "Team 2",
                            area_size: "38,500 m¬≤",
                            priority: "High"
                        },
                        {
                            id: 3,
                            division_id: "DIV-C",
                            name: "Division Charlie",
                            status: "unassigned",
                            team: null,
                            area_size: "42,000 m¬≤",
                            priority: "Medium"
                        },
                        {
                            id: 4,
                            division_id: "DIV-D",
                            name: "Division Delta",
                            status: "completed",
                            team: "Team 3",
                            area_size: "39,000 m¬≤",
                            priority: "Low"
                        }
                    ]
                };
                
                incidentData = mockData;
                displayIncidentData();
                updateMap();
                
            } catch (error) {
                showStatus('Error loading incident data: ' + error.message, 'error');
                document.getElementById('loadingDiv').innerHTML = '<p>Error loading incident data</p>';
            }
        }
        
        // Display incident data in the UI
        function displayIncidentData() {
            if (!incidentData) return;
            
            // Update title
            document.getElementById('incidentTitle').textContent = incidentData.name;
            
            // Update incident info
            const incidentInfo = document.getElementById('incidentInfo');
            incidentInfo.innerHTML = `
                <p><strong>ID:</strong> ${incidentData.incident_id}</p>
                <p><strong>Type:</strong> ${incidentData.incident_type}</p>
                <p><strong>Status:</strong> <span class="division-status status-${incidentData.status}">${incidentData.status.toUpperCase()}</span></p>
                <p><strong>Created:</strong> ${new Date(incidentData.created_at).toLocaleString()}</p>
                <p><strong>Description:</strong> ${incidentData.description}</p>
            `;
            
            // Update location info
            const locationInfo = document.getElementById('locationInfo');
            if (incidentData.location) {
                locationInfo.innerHTML = `
                    <p><strong>Address:</strong> ${incidentData.location.address}</p>
                    <p><strong>Coordinates:</strong> ${incidentData.location.latitude.toFixed(6)}, ${incidentData.location.longitude.toFixed(6)}</p>
                `;
            } else {
                locationInfo.innerHTML = '<p>Location not set</p>';
            }
            
            // Update divisions summary
            const summary = document.getElementById('divisionsSummary');
            const totalDivisions = incidentData.divisions.length;
            const assignedDivisions = incidentData.divisions.filter(d => d.status === 'assigned').length;
            const completedDivisions = incidentData.divisions.filter(d => d.status === 'completed').length;
            
            summary.innerHTML = `
                <p><strong>Total Divisions:</strong> ${totalDivisions} | 
                <strong>Assigned:</strong> ${assignedDivisions} | 
                <strong>Completed:</strong> ${completedDivisions} | 
                <strong>Unassigned:</strong> ${totalDivisions - assignedDivisions - completedDivisions}</p>
            `;
            
            // Display division cards
            const divisionsList = document.getElementById('divisionsList');
            divisionsList.innerHTML = incidentData.divisions.map(division => `
                <div class="division-card">
                    <h4>${division.name} (${division.division_id})</h4>
                    <p><strong>Status:</strong> <span class="division-status status-${division.status}">${division.status.toUpperCase()}</span></p>
                    <p><strong>Team:</strong> ${division.team || 'Not assigned'}</p>
                    <p><strong>Area:</strong> ${division.area_size}</p>
                    <p><strong>Priority:</strong> ${division.priority}</p>
                </div>
            `).join('');
            
            // Show content, hide loading
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('incidentContent').style.display = 'block';
        }
        
        // Update map with incident data
        function updateMap() {
            if (!incidentData) return;
            
            // Add incident location marker
            if (incidentData.location) {
                if (incidentMarker) {
                    map.removeLayer(incidentMarker);
                }
                
                incidentMarker = L.marker([incidentData.location.latitude, incidentData.location.longitude], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#d32f2f" width="32" height="32">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                        `),
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(map);
                
                incidentMarker.bindPopup(`<b>Incident Location</b><br>${incidentData.location.address}`);
                
                map.setView([incidentData.location.latitude, incidentData.location.longitude], 14);
            }
            
            // Add search area
            if (incidentData.search_area && incidentData.search_area.coordinates) {
                searchAreaLayer.clearLayers();
                
                const searchArea = L.polygon(
                    incidentData.search_area.coordinates.map(coord => [coord[1], coord[0]]), // Convert lng,lat to lat,lng
                    {
                        color: '#ff0000',
                        weight: 3,
                        fillOpacity: 0.2,
                        fillColor: '#ff0000'
                    }
                ).addTo(searchAreaLayer);
                
                searchArea.bindPopup('<b>Search Area</b><br>Primary search zone');
            }
            
            // Add division polygons (mock data for demonstration)
            divisionsGroup.clearLayers();
            incidentData.divisions.forEach((division, index) => {
                // Create mock division polygons within the search area
                const baseCoords = incidentData.search_area.coordinates[0];
                const latOffset = (index % 2) * 0.005;
                const lngOffset = Math.floor(index / 2) * 0.005;
                
                const divisionCoords = [
                    [baseCoords[1] + latOffset, baseCoords[0] + lngOffset],
                    [baseCoords[1] + latOffset + 0.004, baseCoords[0] + lngOffset],
                    [baseCoords[1] + latOffset + 0.004, baseCoords[0] + lngOffset + 0.004],
                    [baseCoords[1] + latOffset, baseCoords[0] + lngOffset + 0.004]
                ];
                
                const color = division.status === 'assigned' ? '#4caf50' : 
                             division.status === 'completed' ? '#9c27b0' : '#ff9800';
                
                const divisionPolygon = L.polygon(divisionCoords, {
                    color: color,
                    weight: 2,
                    fillOpacity: 0.3,
                    fillColor: color
                }).addTo(divisionsGroup);
                
                divisionPolygon.bindPopup(`
                    <b>${division.name}</b><br>
                    Status: ${division.status}<br>
                    Team: ${division.team || 'Not assigned'}<br>
                    Area: ${division.area_size}
                `);
            });
        }
        
        // Center map on incident
        function centerMap() {
            if (incidentData && incidentData.location) {
                map.setView([incidentData.location.latitude, incidentData.location.longitude], 14);
            }
        }
        
        // Toggle divisions visibility
        function toggleDivisions() {
            divisionsVisible = !divisionsVisible;
            if (divisionsVisible) {
                map.addLayer(divisionsGroup);
                document.getElementById('toggleDivisionsBtn').textContent = 'üëÅÔ∏è Hide Divisions';
            } else {
                map.removeLayer(divisionsGroup);
                document.getElementById('toggleDivisionsBtn').textContent = 'üëÅÔ∏è Show Divisions';
            }
        }
        
        // Refresh data
        function refreshData() {
            showStatus('Refreshing incident data...', 'success');
            loadIncidentData();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadIncidentData();
            
            // Event listeners
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('toggleDivisionsBtn').addEventListener('click', toggleDivisions);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        });
    </script>
</body>
</html>