        // Display divisions on map
        function displayDivisionsOnMap(divisions) {
            console.log('Displaying divisions on map:', divisions.length); // Debug
            if (!divisions || divisions.length === 0) return;
            
            divisionsGroup.clearLayers();
            
            divisions.forEach((division, index) => {
                console.log('Processing division:', division.division_id, division); // Debug
                
                const color = division.status === 'assigned' ? '#198754' : 
                             division.status === 'completed' ? '#17a2b8' : '#ffc107';
                
                let coordinates = null;
                
                // Parse coordinates from different possible formats
                if (division.coordinates) {
                    console.log('Using division.coordinates'); // Debug
                    coordinates = division.coordinates.map(coord => [coord[1], coord[0]]);
                } else if (division.area_coordinates) {
                    console.log('Using division.area_coordinates'); // Debug
                    coordinates = division.area_coordinates.map(coord => [coord[1], coord[0]]);
                } else if (division.geometry_geojson) {
                    console.log('Using division.geometry_geojson'); // Debug
                    try {
                        const geom = typeof division.geometry_geojson === 'string' ? 
                            JSON.parse(division.geometry_geojson) : division.geometry_geojson;
                        if (geom.coordinates && geom.coordinates[0]) {
                            coordinates = geom.coordinates[0].map(coord => [coord[1], coord[0]]);
                        }
                    } catch (e) {
                        console.error('Error parsing division geometry_geojson:', e);
                    }
                } else if (division.geom) {
                    console.log('Using division.geom'); // Debug
                    try {
                        const geom = typeof division.geom === 'string' ? JSON.parse(division.geom) : division.geom;
                        if (geom.coordinates && geom.coordinates[0]) {
                            coordinates = geom.coordinates[0].map(coord => [coord[1], coord[0]]);
                        }
                    } catch (e) {
                        console.error('Error parsing division geometry:', e);
                    }
                }
                
                console.log('Division coordinates:', coordinates); // Debug
                
                if (coordinates && coordinates.length > 0) {
                    const divisionPolygon = L.polygon(coordinates, {
                        color: color,
                        weight: 2,
                        fillOpacity: 0.4,
                        fillColor: color
                    }).addTo(divisionsGroup);
                    
                    // Add label in center of division
                    const center = divisionPolygon.getBounds().getCenter();
                    const label = L.marker(center, {
                        icon: L.divIcon({
                            className: 'division-label',
                            html: `<div style="background: white; border: 2px solid ${color}; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">${division.division_id || division.name}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(divisionsGroup);
                    
                    const popupContent = `
                        <b>${division.division_name || division.name}</b><br>
                        <strong>ID:</strong> ${division.division_id}<br>
                        <strong>Status:</strong> ${division.status || 'unassigned'}<br>
                        <strong>Team:</strong> ${division.assigned_team || 'Not assigned'}<br>
                        <strong>Leader:</strong> ${division.team_leader || 'Not assigned'}<br>
                        <strong>Priority:</strong> ${division.priority || 'Medium'}
                    `;
                    
                    divisionPolygon.bindPopup(popupContent);
                    label.bindPopup(popupContent);
                    
                    console.log('Added division polygon to map'); // Debug
                } else {
                    console.log('No valid coordinates for division:', division.division_id); // Debug
                }
            });
            
            console.log('Total features in divisionsGroup:', divisionsGroup.getLayers().length); // Debug
        }