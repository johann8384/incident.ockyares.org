<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Status Update</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h4>Unit Status Update</h4>
                        <small class="text-muted">Incident: {{ incident_id }}</small>
                    </div>
                    <div class="card-body">
                        <form id="statusForm">
                            <div class="mb-3">
                                <label class="form-label">Unit ID</label>
                                <input type="text" class="form-control" id="unitId" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status" required>
                                    <option value="">Select Status</option>
                                    <option value="staging">Staging</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="operating">Operating</option>
                                    <option value="recovering">Recovering</option>
                                    <option value="out_of_service">Out of Service</option>
                                    <option value="quarters">Quarters</option>
                                </select>
                            </div>

                            <div class="mb-3" id="divisionSection" style="display: none;">
                                <label class="form-label">Division</label>
                                <select class="form-select" id="division">
                                    <option value="">Select Division</option>
                                </select>
                            </div>

                            <div class="mb-3" id="percentageSection" style="display: none;">
                                <label class="form-label">Percentage Complete</label>
                                <input type="range" class="form-range" id="percentage" min="0" max="100" value="0">
                                <div class="text-center">
                                    <span id="percentageValue">0%</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="number" class="form-control" id="latitude" 
                                               placeholder="Latitude" step="any">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control" id="longitude" 
                                               placeholder="Longitude" step="any">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="getCurrentLocation">
                                    Get Current Location
                                </button>
                            </div>

                            <div class="mb-3">
                                <div id="map" style="height: 300px;"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" rows="3" 
                                         placeholder="Additional notes or observations"></textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Your Name</label>
                                <input type="text" class="form-control" id="userName" 
                                       placeholder="Officer/Member name">
                            </div>

                            <button type="submit" class="btn btn-primary w-100">Update Status</button>
                        </form>
                    </div>
                </div>

                <div id="statusHistory" class="card mt-3" style="display: none;">
                    <div class="card-header">
                        <h5>Status History</h5>
                    </div>
                    <div class="card-body">
                        <div id="historyList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Alerts -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div id="alertContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const incidentId = '{{ incident_id }}';
        let map, marker;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([37.7749, -122.4194], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            map.on('click', function(e) {
                updateMapLocation(e.latlng.lat, e.latlng.lng);
            });
        }

        function updateMapLocation(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            map.setView([lat, lng], 15);
        }

        // Load divisions for incident
        async function loadDivisions() {
            try {
                const response = await fetch(`/api/incident/${incidentId}/divisions`);
                const data = await response.json();
                
                const divisionSelect = document.getElementById('division');
                divisionSelect.innerHTML = '<option value="">Select Division</option>';
                
                if (data.success && data.divisions) {
                    data.divisions.forEach(division => {
                        const option = document.createElement('option');
                        option.value = division.division_id;
                        option.textContent = division.division_name;
                        divisionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading divisions:', error);
            }
        }

        // Status change handler
        document.getElementById('status').addEventListener('change', function() {
            const status = this.value;
            const divisionSection = document.getElementById('divisionSection');
            const percentageSection = document.getElementById('percentageSection');
            
            // Show division selection for assigned/operating/recovering
            if (['assigned', 'operating', 'recovering'].includes(status)) {
                divisionSection.style.display = 'block';
            } else {
                divisionSection.style.display = 'none';
            }
            
            // Show percentage for operating status
            if (status === 'operating') {
                percentageSection.style.display = 'block';
            } else {
                percentageSection.style.display = 'none';
            }
        });

        // Percentage slider handler
        document.getElementById('percentage').addEventListener('input', function() {
            document.getElementById('percentageValue').textContent = this.value + '%';
        });

        // Get current location
        document.getElementById('getCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    updateMapLocation(position.coords.latitude, position.coords.longitude);
                }, function(error) {
                    showAlert('Error getting location: ' + error.message, 'danger');
                });
            } else {
                showAlert('Geolocation is not supported by this browser', 'danger');
            }
        });

        // Form submission
        document.getElementById('statusForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                incident_id: incidentId,
                status: document.getElementById('status').value,
                division_id: document.getElementById('division').value || null,
                percentage_complete: document.getElementById('percentage').value,
                latitude: document.getElementById('latitude').value || null,
                longitude: document.getElementById('longitude').value || null,
                notes: document.getElementById('notes').value,
                user_name: document.getElementById('userName').value
            };

            try {
                const response = await fetch(`/api/unit/${formData.unit_id || document.getElementById('unitId').value}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Status updated successfully', 'success');
                    loadStatusHistory();
                } else {
                    showAlert(data.error || 'Failed to update status', 'danger');
                }
            } catch (error) {
                showAlert('Error updating status: ' + error.message, 'danger');
            }
        });

        // Load status history
        async function loadStatusHistory() {
            const unitId = document.getElementById('unitId').value;
            if (!unitId) return;

            try {
                const response = await fetch(`/api/unit/${unitId}/history?incident_id=${incidentId}`);
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    data.history.forEach(entry => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'border-bottom pb-2 mb-2';
                        historyItem.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <strong>${entry.status.replace('_', ' ').toUpperCase()}</strong>
                                <small class="text-muted">${new Date(entry.timestamp).toLocaleString()}</small>
                            </div>
                            ${entry.division_name ? `<div>Division: ${entry.division_name}</div>` : ''}
                            ${entry.percentage_complete > 0 ? `<div>Progress: ${entry.percentage_complete}%</div>` : ''}
                            ${entry.notes ? `<div class="text-muted">${entry.notes}</div>` : ''}
                        `;
                        historyList.appendChild(historyItem);
                    });
                    
                    document.getElementById('statusHistory').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading status history:', error);
            }
        }

        // Unit ID change handler
        document.getElementById('unitId').addEventListener('blur', function() {
            if (this.value) {
                loadStatusHistory();
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadDivisions();
        });
    </script>
</body>
</html>
