{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Create New Incident</h1>
        
        <div class="alert alert-success" id="success-alert">
            <strong>Success!</strong> Incident created successfully.
            <a href="#" id="view-incident-link">View Incident Details</a>
        </div>
        
        <div class="alert alert-danger" id="error-alert" style="display: none;">
            <strong>Error!</strong> <span id="error-message"></span>
        </div>
        
        <form id="incident-form">
            <!-- Incident Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Incident Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="incident_name" class="form-label">Incident Name *</label>
                                <input type="text" class="form-control" id="incident_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="incident_type" class="form-label">Incident Type *</label>
                                <select class="form-control" id="incident_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Urban Search & Rescue">Urban Search & Rescue</option>
                                    <option value="Wilderness SAR">Wilderness SAR</option>
                                    <option value="Building Collapse">Building Collapse</option>
                                    <option value="Natural Disaster">Natural Disaster</option>
                                    <option value="HAZMAT">HAZMAT</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ic_name" class="form-label">Incident Commander *</label>
                                <input type="text" class="form-control" id="ic_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="grid_size" class="form-label">Division Grid Size (meters)</label>
                                <input type="number" class="form-control" id="grid_size" value="100" min="50" max="500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Location and Search Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Location and Search Area</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="latitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="latitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="longitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="longitude" step="any" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Instructions:</strong> 
                        1. Enter coordinates above or click on the map to set incident location<br>
                        2. Use the drawing tools to outline the search area<br>
                        3. The system will automatically create divisions based on your grid size
                    </div>
                    
                    <div id="map" class="map-container"></div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary" id="clear-area">Clear Search Area</button>
                        <span class="text-muted ms-3" id="area-status">No search area defined</span>
                    </div>
                </div>
            </div>
            
            <!-- Teams -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Search Teams</h3>
                    <button type="button" class="btn btn-success btn-sm float-end" id="add-team">Add Team</button>
                </div>
                <div class="card-body">
                    <div id="teams-container">
                        <!-- Teams will be added here dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <span class="spinner-border spinner-border-sm me-2" id="loading-spinner" style="display: none;"></span>
                    Create Incident and Generate QR Codes
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let map;
let incidentMarker;
let searchAreaLayer;
let searchAreaCoordinates = [];

// Initialize map
function initMap() {
    map = L.map('map').setView([38.395622, -85.441712], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Click handler for incident location
    map.on('click', function(e) {
        if (incidentMarker) {
            map.removeLayer(incidentMarker);
        }
        
        incidentMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
        document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
    });
    
    // Drawing control for search area
    map.on('click', function(e) {
        if (map.drawingMode) {
            searchAreaCoordinates.push([e.latlng.lng, e.latlng.lat]);
            updateSearchArea();
        }
    });
}

// Toggle drawing mode
function toggleDrawingMode() {
    map.drawingMode = !map.drawingMode;
    document.getElementById('drawing-btn').textContent = 
        map.drawingMode ? 'Stop Drawing' : 'Draw Search Area';
}

// Update search area display
function updateSearchArea() {
    if (searchAreaLayer) {
        map.removeLayer(searchAreaLayer);
    }
    
    if (searchAreaCoordinates.length >= 3) {
        // Close the polygon
        let coords = [...searchAreaCoordinates];
        if (coords[0] !== coords[coords.length - 1]) {
            coords.push(coords[0]);
        }
        
        // Convert to leaflet format [lat, lng]
        let leafletCoords = coords.map(coord => [coord[1], coord[0]]);
        
        searchAreaLayer = L.polygon(leafletCoords, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.3
        }).addTo(map);
        
        document.getElementById('area-status').textContent = 
            `Search area defined with ${searchAreaCoordinates.length} points`;
    }
}

// Clear search area
function clearSearchArea() {
    searchAreaCoordinates = [];
    if (searchAreaLayer) {
        map.removeLayer(searchAreaLayer);
        searchAreaLayer = null;
    }
    document.getElementById('area-status').textContent = 'No search area defined';
}

// Team management
let teamCounter = 0;

function addTeam() {
    teamCounter++;
    const teamHtml = `
        <div class="team-card" id="team-${teamCounter}">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Team Name</label>
                    <input type="text" class="form-control team-name" placeholder="Team Alpha">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Team Leader</label>
                    <input type="text" class="form-control team-leader" placeholder="Captain Smith">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Team ID</label>
                    <input type="text" class="form-control team-id" value="team${teamCounter}" readonly>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeTeam(${teamCounter})">Remove</button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('teams-container').insertAdjacentHTML('beforeend', teamHtml);
}

function removeTeam(teamId) {
    document.getElementById(`team-${teamId}`).remove();
}

// Form submission
function submitForm(e) {
    e.preventDefault();
    
    // Show loading state
    document.getElementById('loading-spinner').style.display = 'inline-block';
    document.getElementById('submit-btn').disabled = true;
    
    // Collect form data
    const formData = {
        incident: {
            incident_name: document.getElementById('incident_name').value,
            incident_type: document.getElementById('incident_type').value,
            ic_name: document.getElementById('ic_name').value,
            latitude: document.getElementById('latitude').value,
            longitude: document.getElementById('longitude').value,
            description: document.getElementById('description').value
        },
        search_area_coordinates: searchAreaCoordinates,
        grid_size: parseInt(document.getElementById('grid_size').value),
        teams: []
    };
    
    // Collect team data
    document.querySelectorAll('.team-card').forEach(card => {
        const teamData = {
            team_name: card.querySelector('.team-name').value,
            team_leader: card.querySelector('.team-leader').value,
            team_id: card.querySelector('.team-id').value
        };
        if (teamData.team_name && teamData.team_leader) {
            formData.teams.push(teamData);
        }
    });
    
    // Validate
    if (searchAreaCoordinates.length < 3) {
        showError('Please define a search area with at least 3 points');
        return;
    }
    
    // Submit to backend
    fetch('/create_incident', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.incident_id);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    })
    .finally(() => {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
    });
}

function showSuccess(incidentId) {
    document.getElementById('success-alert').style.display = 'block';
    document.getElementById('view-incident-link').href = `/incident/${incidentId}`;
    document.getElementById('error-alert').style.display = 'none';
    
    // Scroll to top
    window.scrollTo(0, 0);
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-alert').style.display = 'block';
    document.getElementById('success-alert').style.display = 'none';
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    document.getElementById('add-team').addEventListener('click', addTeam);
    document.getElementById('clear-area').addEventListener('click', clearSearchArea);
    document.getElementById('incident-form').addEventListener('submit', submitForm);
    
    // Add some default teams
    addTeam();
    addTeam();
    addTeam();
    
    // Set default team names
    setTimeout(() => {
        const teamCards = document.querySelectorAll('.team-card');
        if (teamCards[0]) {
            teamCards[0].querySelector('.team-name').value = 'Team Alpha';
            teamCards[0].querySelector('.team-leader').value = 'Captain Smith';
        }
        if (teamCards[1]) {
            teamCards[1].querySelector('.team-name').value = 'Team Bravo';
            teamCards[1].querySelector('.team-leader').value = 'Captain Jones';
        }
        if (teamCards[2]) {
            teamCards[2].querySelector('.team-name').value = 'Team Charlie';
            teamCards[2].querySelector('.team-leader').value = 'Captain Brown';
        }
    }, 100);
});

// Add polygon drawing functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add drawing button to map
    const drawingBtn = document.createElement('button');
    drawingBtn.id = 'drawing-btn';
    drawingBtn.className = 'btn btn-outline-primary btn-sm';
    drawingBtn.textContent = 'Draw Search Area';
    drawingBtn.style.position = 'absolute';
    drawingBtn.style.top = '10px';
    drawingBtn.style.right = '10px';
    drawingBtn.style.zIndex = '1000';
    
    document.getElementById('map').appendChild(drawingBtn);
    
    drawingBtn.addEventListener('click', function() {
        if (!map.drawingMode) {
            // Start drawing
            map.drawingMode = true;
            this.textContent = 'Finish Drawing';
            this.className = 'btn btn-success btn-sm';
            searchAreaCoordinates = []; // Reset coordinates
        } else {
            // Finish drawing
            map.drawingMode = false;
            this.textContent = 'Draw Search Area';
            this.className = 'btn btn-outline-primary btn-sm';
            
            if (searchAreaCoordinates.length >= 3) {
                updateSearchArea();
            }
        }
    });
});
</script>
{% endblock %}
