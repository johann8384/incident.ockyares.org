{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Create New Incident</h1>
        
        <div class="alert alert-success" id="success-alert">
            <strong>Success!</strong> Incident created successfully.
            <a href="#" id="view-incident-link">View Incident Details</a>
        </div>
        
        <div class="alert alert-danger" id="error-alert" style="display: none;">
            <strong>Error!</strong> <span id="error-message"></span>
        </div>
        
        <form id="incident-form">
            <!-- Incident Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Incident Information</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="incident_name" class="form-label">Incident Name *</label>
                                <input type="text" class="form-control" id="incident_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="incident_type" class="form-label">Incident Type *</label>
                                <select class="form-control" id="incident_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Urban Search & Rescue">Urban Search & Rescue</option>
                                    <option value="Wilderness SAR">Wilderness SAR</option>
                                    <option value="Building Collapse">Building Collapse</option>
                                    <option value="Natural Disaster">Natural Disaster</option>
                                    <option value="HAZMAT">HAZMAT</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="ic_name" class="form-label">Incident Commander *</label>
                                <input type="text" class="form-control" id="ic_name" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Location and Search Area -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Location and Search Area</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="latitude" class="form-label">Latitude *</label>
                                <input type="number" class="form-control" id="latitude" step="any" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="longitude" class="form-label">Longitude *</label>
                                <input type="number" class="form-control" id="longitude" step="any" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Instructions:</strong> 
                        1. Enter coordinates above or click on the map to set incident location<br>
                        2. Use the drawing tools to outline the search area<br>
                        3. The system will automatically calculate recommended divisions based on area size
                    </div>
                    
                    <div id="map" class="map-container"></div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-primary" id="clear-area">Clear Search Area</button>
                        <span class="text-muted ms-3" id="area-status">No search area defined</span>
                    </div>
                </div>
            </div>
            
            <!-- Search Divisions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Search Divisions</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="division_count" class="form-label">Number of Search Divisions *</label>
                                <input type="number" class="form-control" id="division_count" min="1" max="26" value="4" required>
                                <div class="form-text">
                                    <span id="division-recommendation">Recommended: 4 divisions based on default area</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Search Area Information</label>
                                <div class="form-control-plaintext">
                                    <div id="area-size">Area: Not calculated</div>
                                    <div id="division-size">Avg. division size: Not calculated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>Note:</strong> Each division will be approximately 45,000 m² (4.5 hectares) based on the recommended calculation. 
                        You can adjust the number of divisions as needed for your operational requirements.
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                    <span class="spinner-border spinner-border-sm me-2" id="loading-spinner" style="display: none;"></span>
                    Create Incident and Generate Divisions
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let map;
let incidentMarker;
let searchAreaLayer;
let searchAreaCoordinates = [];
let searchAreaSizeM2 = 0;

// Initialize map
function initMap() {
    map = L.map('map').setView([38.395622, -85.441712], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Click handler for incident location
    map.on('click', function(e) {
        if (incidentMarker) {
            map.removeLayer(incidentMarker);
        }
        
        incidentMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
        document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
    });
    
    // Drawing control for search area
    map.on('click', function(e) {
        if (map.drawingMode) {
            searchAreaCoordinates.push([e.latlng.lng, e.latlng.lat]);
            updateSearchArea();
        }
    });
}

// Calculate area using Shoelace formula (approximate)
function calculatePolygonAreaM2(coords) {
    if (coords.length < 3) return 0;
    
    // Convert to meters using approximate conversion
    // This is a rough approximation - for precise calculations, proper projection should be used
    let area = 0;
    const avgLat = coords.reduce((sum, coord) => sum + coord[1], 0) / coords.length;
    const mPerDegreeLat = 111320; // meters per degree latitude
    const mPerDegreeLng = 111320 * Math.cos(avgLat * Math.PI / 180); // meters per degree longitude at this latitude
    
    // Convert coordinates to meters
    const coordsM = coords.map(coord => [
        coord[0] * mPerDegreeLng,
        coord[1] * mPerDegreeLat
    ]);
    
    // Shoelace formula
    for (let i = 0; i < coordsM.length; i++) {
        const j = (i + 1) % coordsM.length;
        area += coordsM[i][0] * coordsM[j][1];
        area -= coordsM[j][0] * coordsM[i][1];
    }
    
    return Math.abs(area) / 2;
}

// Update search area display and calculate divisions
function updateSearchArea() {
    if (searchAreaLayer) {
        map.removeLayer(searchAreaLayer);
    }
    
    if (searchAreaCoordinates.length >= 3) {
        // Close the polygon
        let coords = [...searchAreaCoordinates];
        if (coords[0] !== coords[coords.length - 1]) {
            coords.push(coords[0]);
        }
        
        // Convert to leaflet format [lat, lng]
        let leafletCoords = coords.map(coord => [coord[1], coord[0]]);
        
        searchAreaLayer = L.polygon(leafletCoords, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.3
        }).addTo(map);
        
        // Calculate area
        searchAreaSizeM2 = calculatePolygonAreaM2(coords);
        
        // Calculate recommended divisions (45,000 m² per division)
        const recommendedDivisions = Math.max(1, Math.round(searchAreaSizeM2 / 45000));
        
        // Update UI
        document.getElementById('area-status').textContent = 
            `Search area defined with ${searchAreaCoordinates.length} points`;
        
        document.getElementById('area-size').textContent = 
            `Area: ${(searchAreaSizeM2 / 10000).toFixed(2)} hectares (${searchAreaSizeM2.toLocaleString()} m²)`;
        
        document.getElementById('division-recommendation').textContent = 
            `Recommended: ${recommendedDivisions} divisions based on area size`;
        
        document.getElementById('division_count').value = recommendedDivisions;
        
        updateDivisionInfo();
    }
}

// Update division size information
function updateDivisionInfo() {
    const divisionCount = parseInt(document.getElementById('division_count').value) || 1;
    if (searchAreaSizeM2 > 0) {
        const avgDivisionSize = searchAreaSizeM2 / divisionCount;
        document.getElementById('division-size').textContent = 
            `Avg. division size: ${(avgDivisionSize / 10000).toFixed(2)} hectares (${avgDivisionSize.toLocaleString()} m²)`;
    }
}

// Clear search area
function clearSearchArea() {
    searchAreaCoordinates = [];
    searchAreaSizeM2 = 0;
    if (searchAreaLayer) {
        map.removeLayer(searchAreaLayer);
        searchAreaLayer = null;
    }
    document.getElementById('area-status').textContent = 'No search area defined';
    document.getElementById('area-size').textContent = 'Area: Not calculated';
    document.getElementById('division-size').textContent = 'Avg. division size: Not calculated';
    document.getElementById('division-recommendation').textContent = 'Recommended: 4 divisions based on default area';
    document.getElementById('division_count').value = 4;
}

// Form submission
function submitForm(e) {
    e.preventDefault();
    
    // Show loading state
    document.getElementById('loading-spinner').style.display = 'inline-block';
    document.getElementById('submit-btn').disabled = true;
    
    // Collect form data
    const formData = {
        incident: {
            incident_name: document.getElementById('incident_name').value,
            incident_type: document.getElementById('incident_type').value,
            ic_name: document.getElementById('ic_name').value,
            latitude: document.getElementById('latitude').value,
            longitude: document.getElementById('longitude').value,
            description: document.getElementById('description').value
        },
        search_area_coordinates: searchAreaCoordinates,
        division_count: parseInt(document.getElementById('division_count').value),
        teams: [] // Empty teams array - divisions will be created without pre-assigned teams
    };
    
    // Validate
    if (searchAreaCoordinates.length < 3) {
        showError('Please define a search area with at least 3 points');
        return;
    }
    
    if (!formData.division_count || formData.division_count < 1) {
        showError('Please specify at least 1 search division');
        return;
    }
    
    // Submit to backend
    fetch('/create_incident', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.incident_id);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    })
    .finally(() => {
        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
    });
}

function showSuccess(incidentId) {
    document.getElementById('success-alert').style.display = 'block';
    document.getElementById('view-incident-link').href = `/incident/${incidentId}`;
    document.getElementById('error-alert').style.display = 'none';
    
    // Scroll to top
    window.scrollTo(0, 0);
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-alert').style.display = 'block';
    document.getElementById('success-alert').style.display = 'none';
    
    // Scroll to top
    window.scrollTo(0, 0);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    document.getElementById('clear-area').addEventListener('click', clearSearchArea);
    document.getElementById('incident-form').addEventListener('submit', submitForm);
    
    // Listen for division count changes
    document.getElementById('division_count').addEventListener('input', updateDivisionInfo);
});

// Add polygon drawing functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add drawing button to map
    const drawingBtn = document.createElement('button');
    drawingBtn.id = 'drawing-btn';
    drawingBtn.className = 'btn btn-outline-primary btn-sm';
    drawingBtn.textContent = 'Draw Search Area';
    drawingBtn.style.position = 'absolute';
    drawingBtn.style.top = '10px';
    drawingBtn.style.right = '10px';
    drawingBtn.style.zIndex = '1000';
    
    document.getElementById('map').appendChild(drawingBtn);
    
    drawingBtn.addEventListener('click', function() {
        if (!map.drawingMode) {
            // Start drawing
            map.drawingMode = true;
            this.textContent = 'Finish Drawing';
            this.className = 'btn btn-success btn-sm';
            searchAreaCoordinates = []; // Reset coordinates
        } else {
            // Finish drawing
            map.drawingMode = false;
            this.textContent = 'Draw Search Area';
            this.className = 'btn btn-outline-primary btn-sm';
            
            if (searchAreaCoordinates.length >= 3) {
                updateSearchArea();
            }
        }
    });
});
</script>
{% endblock %}
